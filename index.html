<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>play-bin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <style>
        :root {
            --bg: #0d0d0d;
            --panel: #1a1a1a;
            --border: #333;
            --accent: #0081cc;
            --danger: #cc3333;
            --success: #4caf50;
            --warning: #f39c12;
            --text: #eee;
            --muted: #888;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* --- モーダル --- */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal {
            background: var(--panel);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border);
            width: 350px;
            text-align: center;
        }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        /* --- レイアウト --- */
        #login-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 1000;
        }

        .login-card {
            background: var(--panel);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            width: 320px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid var(--border);
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: #333;
            color: white;
            font-size: 12px;
            transition: 0.2s;
        }

        button:hover {
            background: #444;
        }

        button.primary {
            background: var(--accent);
            border: none;
            font-weight: bold;
        }

        button.danger {
            background: var(--danger);
            border: none;
        }

        button.success {
            background: var(--success);
            border: none;
        }

        button.warning {
            background: var(--warning);
            border: none;
            color: #000;
            font-weight: bold;
        }

        #app {
            display: none;
            height: 100vh;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 50px 1fr 220px;
        }

        header {
            grid-column: 1 / -1;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        #sidebar {
            grid-row: 2 / 4;
            background: var(--panel);
            border-right: 1px solid var(--border);
            padding: 10px;
            overflow-y: auto;
        }

        .container-item {
            padding: 10px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .container-item:hover {
            background: #2a2a2a;
        }

        .container-item.active {
            background: #222;
            border-left: 4px solid var(--accent);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 12px;
            background: var(--muted);
        }

        .dot.running {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        #main-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-box {
            flex: 1;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .term-header {
            background: #222;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        #xterm-container {
            flex: 1;
            position: relative;
            background: #000;
        }

        #term-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            background: #000;
            z-index: 5;
        }

        #detail-panel {
            grid-column: 2;
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 12px;
            display: grid;
            grid-template-columns: 200px 200px 1fr 1fr;
            gap: 12px;
        }

        .metric-card {
            background: #222;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .metric-label {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 15px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .progress-bg {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-bottom: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 85px 1fr;
            gap: 4px;
            font-size: 11px;
            color: #ccc;
        }

        .info-grid span:nth-child(odd) {
            color: var(--muted);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
        }

        .scroll-list {
            font-size: 10px;
            color: #aaa;
            margin-top: 2px;
            border-top: 1px solid #333;
            padding-top: 4px;
        }
    </style>
</head>

<body>

    <div id="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-body" style="font-size: 14px; color: var(--muted);">Are you sure?</p>
            <div class="modal-btns">
                <button onclick="closeModal()">Cancel</button>
                <button id="modal-confirm-btn" class="primary">Execute</button>
            </div>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <h2>play-bin</h2>
            <form id="login-form" onsubmit="event.preventDefault(); doLogin();">
                <input type="text" placeholder="Username" id="user" autocomplete="username">
                <input type="password" placeholder="Password" id="password" autocomplete="current-password">
                <button type="submit" class="primary">Login</button>
            </form>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="font-weight:600">play-bin</div>
            <div id="session-info" style="font-size:12px; color:var(--muted)">Session: Active</div>
        </header>

        <div id="sidebar">
            <div style="color:var(--muted); font-size:11px; margin-bottom:10px; padding-left:10px;">CONTAINERS</div>
            <div id="list-target"></div>
        </div>

        <div id="main-content">
            <div class="terminal-box">
                <div class="term-header">
                    <span id="term-name">Console: No Container Selected</span>
                    <div class="btn-group">
                        <button id="btn-start" class="success" onclick="confirmAction('start')" style="display:none;">Start</button>
                        <button id="btn-stop" class="danger" onclick="confirmAction('stop')" style="display:none;">Stop</button>

                        <span id="control-divider" style="margin: 0 5px; border-left: 1px solid #444; height: 20px; display:none;"></span>

                        <span id="term-controls" style="display: flex; gap: 5px;">
                            <button id="btn-attach" class="warning" onclick="confirmAction('attach')">Attach</button>
                            <button id="btn-exec" onclick="connectTerminal('exec')">Exec</button>
                            <button id="btn-logs" onclick="connectTerminal('logs')">Tail Logs</button>
                        </span>

                        <button id="btn-disconnect" class="danger" onclick="disconnectTerminal()" style="display:none;">Disconnect</button>
                    </div>
                </div>
                <div id="xterm-container">
                    <div id="term-placeholder">Select a container</div>
                    <div id="terminal" style="height: 100%;"></div>
                </div>
            </div>
        </div>

        <div id="detail-panel">
            <div class="metric-card">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value" id="cpu-text">-</div>
                <div class="progress-bg">
                    <div id="cpu-bar" class="progress-fill"></div>
                </div>
                <div class="metric-label">Memory Usage</div>
                <div class="metric-value" id="mem-text">-</div>
                <div class="progress-bg">
                    <div id="mem-bar" class="progress-fill"></div>
                </div>
                <div class="metric-label">PID</div>
                <div class="metric-value" id="info-pid" style="color:#eee;">-</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Status</div>
                <div class="metric-value" id="info-status">-</div>
                <div class="metric-label">Uptime</div>
                <div class="metric-value" id="uptime-text">-</div>
                <div class="metric-label">Started At</div>
                <div id="info-started" style="font-size:10px; color:#eee;">-</div>
            </div>
            <div class="metric-card">
                <div class="info-grid">
                    <span>Net Mode</span><span id="info-netmode">-</span>
                    <span>Restart Pol</span><span id="info-restart">-</span>
                    <span>Auto Remove</span><span id="info-autoremove">-</span>
                    <span>Ports Bind</span><span></span>
                </div>
                <div id="info-ports" class="scroll-list"></div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Mounts (Dest / Type)</div>
                <div id="info-mounts" class="scroll-list" style="max-height: 140px;"></div>
            </div>
        </div>
    </div>

    <script>
        // グローバル状態管理
        let token = "";          // API認証用。ログイン成功時にサーバーから付録される
        let selectedId = "";     // コンテナ操作の主体。Docker ID または設定ファイルのサーバー名が入る
        let selectedName = "";   // UI表示用。ユーザーが認識しやすいコンテナ名
        let wsTerm, wsStats;    // WebSocketコネクションを保持し、リアルタイム通信を管理する
        let termDataListener;   // xterm.jsのイベントを購読し、解除可能にするための参照保持

        // MARK: initTerminal()
        // ターミナル(xterm.js)の初期化。UI読み込み時に一度だけ実行する。
        const term = new Terminal({ convertEol: true, cursorBlink: true, theme: { background: '#000' }, fontSize: 13 });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));

        // ウィンドウの大きさが変わった際に、文字がはみ出さないようターミナルのグリッドを再計算させる
        window.addEventListener('resize', () => { try { fitAddon.fit(); } catch (e) { } });

        // MARK: confirmAction()
        // ユーザーがボタンを押した際、誤操作防止のための確認モーダルを表示する。
        function confirmAction(action) {
            // 対象が未選択の状態でアクションを起こさせない（安全ガード）
            if (!selectedId && action !== 'attach') return; 
            const overlay = document.getElementById('modal-overlay');
            const confirmBtn = document.getElementById('modal-confirm-btn');

            document.getElementById('modal-title').innerText = `Container ${action.toUpperCase()}`;

            if (action === 'attach') {
                // Attachはコンテナに直接信号を送るため、Ctrl+C等でコンテナが止まるリスクを警告する
                document.getElementById('modal-body').innerText = `警告: "${selectedName}" に直結します。Ctrl+Cを送るとコンテナが停止する可能性があります。続行しますか？`;
                confirmBtn.onclick = () => { connectTerminal('attach'); closeModal(); };
            } else {
                // 通常の起動・停止確認
                document.getElementById('modal-body').innerText = `本当に "${selectedName}" に対して ${action} を実行しますか？`;
                confirmBtn.onclick = () => { executeContainerAction(action); closeModal(); };
            }

            overlay.style.display = 'flex';
        }

        // MARK: closeModal()
        // 不要になったモーダルを画面から隠す。
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // MARK: executeContainerAction()
        // バックエンドのAPIに向けてコンテナ操作リクエストを送信する。
        async function executeContainerAction(action) {
            try {
                const res = await fetch(`/api/container/${action}?id=${selectedId}`, { method: 'POST', headers: { 'Authorization': token } });
                if (!res.ok) throw new Error(`${action} に失敗しました`);
                // サーバー側での状態変更（Dockerエンジンの遅延）を考慮し、少し待ってからUIを更新する
                setTimeout(() => { fetchContainers(); loadInspectData(selectedId); }, 1000);
            } catch (e) { alert(e.message); }
        }

        // MARK: doLogin()
        // ユーザー識別とトークン取得のための認証リクエストを行う。
        async function doLogin() {
            const userEl = document.getElementById('user'), passEl = document.getElementById('password');
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userEl.value, password: passEl.value })
                });
                if (!res.ok) throw new Error("ログインに失敗しました");
                token = (await res.json()).token;
                // 認証成功後、アプリ画面に切り替えてコンテナ情報を読み込む
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'grid';
                setTimeout(() => fitAddon.fit(), 100);
                fetchContainers();
            } catch (e) { alert(e.message); }
        }

        // MARK: fetchContainers()
        // サイドバーに表示するコンテナの一覧をサーバーから最新化して取得する。
        async function fetchContainers() {
            try {
                const res = await fetch('/api/containers', { headers: { 'Authorization': token } });
                const items = await res.json();
                // リストを構築し、ステータス（実行中かどうか）を色で表現する
                document.getElementById('list-target').innerHTML = items.map(c => {
                    const cId = c.id || "";
                    const cName = (c.names && c.names[0]) ? c.names[0].replace('/', '') : 'Unknown';
                    const state = c.state || "";
                    return `<div class="container-item ${selectedId === cId ? 'active' : ''}" id="c-${cId || cName}" onclick="selectContainer('${cId}', '${cName}')">
                        <div class="dot ${state === 'running' ? 'running' : ''}"></div>${cName}</div>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        // MARK: selectContainer()
        // ユーザーがサイドバーでコンテナを選んだ際の状態変更とUI反映。
        function selectContainer(id, name) {
            // 同じものを再度クリックした場合は何もしない（負荷軽減）
            if (selectedId === id) return;
            selectedId = id; selectedName = name;
            
            // 視認性を高めるため、選ばれた要素を強調し、他を解除する
            document.querySelectorAll('.container-item').forEach(el => el.classList.remove('active'));
            const targetEl = document.getElementById(`c-${id}`) || document.getElementById(`c-${name}`);
            if (targetEl) targetEl.classList.add('active');
            
            document.getElementById('term-name').innerText = `Console: ${name}`;
            // 別のコンテナに切り替わる際は、古い接続をクリーンアップする
            disconnectTerminal();
            loadInspectData(id);
        }

        // MARK: toggleTermButtons()
        // 接続状態に合わせてボタンの表示・非表示を制御する。
        function toggleTermButtons(connected) {
            document.getElementById('term-controls').style.display = connected ? 'none' : 'flex';
            document.getElementById('btn-disconnect').style.display = connected ? 'inline-block' : 'none';
        }

        // MARK: disconnectTerminal()
        // 現在のWebSocket通信を遮断し、ターミナルのリソースを解放する。
        function disconnectTerminal() {
            if (wsTerm) wsTerm.close();
            if (termDataListener) { termDataListener.dispose(); termDataListener = null; }
            term.reset();
            document.getElementById('term-placeholder').style.display = 'flex';
            toggleTermButtons(false);
        }

        // MARK: loadInspectData()
        // コンテナのメタ情報（ネットワーク設定やマウント情報）を取得し、パネルに表示する。
        async function loadInspectData(id) {
            try {
                // コンテナ実体が存在しない（missing）場合でもエラーにならないよう、名前での試行を含める
                const res = await fetch(`/api/container/inspect?id=${id || selectedName}`, { headers: { 'Authorization': token } });
                if (!res.ok) {
                    // Docker側から取得できない場合は情報の更新のみ行う
                    updateDetailUI(null);
                    return;
                }
                const info = await res.json();
                updateDetailUI(info.Raw || info);
            } catch (e) { }
        }

        // MARK: updateDetailUI()
        // バックエンドから得た詳細データをDOM要素に流し込む。
        function updateDetailUI(info) {
            const isRunning = info?.State?.Running;
            const status = (info?.State?.Status || "MISSING").toUpperCase();

            // 状態に応じたボタンの出現・消滅（例：停止中にはStopを出さない）を制御
            document.getElementById('btn-start').style.display = isRunning ? 'none' : 'inline-block';
            document.getElementById('btn-stop').style.display = isRunning ? 'inline-block' : 'none';
            document.getElementById('control-divider').style.display = isRunning || info ? 'inline-block' : 'none';
            
            // コンテナが動いていない時はコンソール操作を行えないように視覚的にも抑制する
            const controls = document.getElementById('term-controls');
            controls.style.opacity = isRunning ? '1' : '0.3';
            controls.style.pointerEvents = isRunning ? 'auto' : 'none';

            // 主要な情報（ステータス、PID、起動時間）の書き換え
            document.getElementById('info-status').innerText = status;
            document.getElementById('info-pid').innerText = info?.State?.Pid || "-";
            
            const started = new Date(info?.State?.StartedAt);
            document.getElementById('info-started').innerText = isNaN(started) ? "-" : started.toLocaleString();
            const uptime = isNaN(started) ? 0 : Math.floor((new Date() - started) / 1000 / 60);
            document.getElementById('uptime-text').innerText = isRunning ? `${uptime} mins` : (info ? "Stopped" : "Not Created");

            // ネットワーク・インフラ構成情報の表示
            document.getElementById('info-netmode').innerText = info?.HostConfig?.NetworkMode || "-";
            document.getElementById('info-restart').innerText = info?.HostConfig?.RestartPolicy?.Name || "-";
            document.getElementById('info-autoremove').innerText = info?.HostConfig?.AutoRemove ? "Yes" : "No";

            // ポートマッピング情報。複数ある場合は改行して表示
            let p = ""; const pb = info?.HostConfig?.PortBindings || {};
            for (let k in pb) p += `<div>${k} ➔ ${pb[k][0].HostPort}</div>`;
            document.getElementById('info-ports').innerHTML = p || "none";
            
            // ディレクトリマウント情報。データの永続化先を確認できるようにする
            document.getElementById('info-mounts').innerHTML = (info?.Mounts || []).map(m =>
                `<div style="margin-bottom:4px; border-bottom:1px solid #333;"><span style="color:var(--accent)">${m.Destination}</span><br>Type: ${m.Type}</div>`
            ).join('') || "none";

            // 稼働中であればCPUやメモリの統計情報を購読開始し、停止していれば購読を解除する
            if (isRunning) startStats(selectedId);
            else if (wsStats) wsStats.close();
        }

        // MARK: connectTerminal()
        // WebSocketを用いてサーバーと中継し、コンテナの入出力をターミナル画面に繋ぐ。
        function connectTerminal(mode) {
            if (!selectedId) return;
            disconnectTerminal();
            document.getElementById('term-placeholder').style.display = 'none';

            wsTerm = new WebSocket(`ws://${location.host}/ws/terminal?id=${selectedId}&mode=${mode}&token=${token}`);
            wsTerm.binaryType = 'arraybuffer';

            wsTerm.onopen = () => {
                fitAddon.fit();
                term.focus(); // 接続後すぐに操作できるようフォーカスを当てる
                toggleTermButtons(true);
                // ログ表示モードの場合は、ストリーミング開始をユーザーに明示する
                if (mode === 'logs') term.write('\x1b[33m--- Tail Logs (Streaming) ---\x1b[0m\r\n');
            };
            // サーバーから送られてきた出力をそのまま xterm.js に流し込む
            wsTerm.onmessage = (e) => term.write(new Uint8Array(e.data));
            wsTerm.onclose = () => toggleTermButtons(false);
            wsTerm.onerror = () => toggleTermButtons(false);

            // ユーザーのキー入力をWebSocket越しにコンテナに転送する（ログモード以外）
            termDataListener = term.onData(data => {
                if (wsTerm?.readyState === 1 && mode !== 'logs') wsTerm.send(data);
            });
        }

        // MARK: startStats()
        // コンテナの負荷状況（CPU・メモリ）のリアルタイム更新を開始する。
        function startStats(id) {
            if (wsStats) wsStats.close();
            wsStats = new WebSocket(`ws://${location.host}/ws/stats?id=${id}&token=${token}`);
            wsStats.onmessage = async (e) => {
                try {
                    const s = JSON.parse((e.data instanceof Blob) ? await e.data.text() : e.data);
                    
                    // CPU使用率の算出（計算式はDocker APIの仕様に基づく）
                    const cpuDelta = (s.cpu_stats.cpu_usage.total_usage - s.precpu_stats.cpu_usage.total_usage);
                    const sysDelta = (s.cpu_stats.system_cpu_usage - s.precpu_stats.system_cpu_usage);
                    const cpu = sysDelta > 0 ? ((cpuDelta / sysDelta) * 100 * s.cpu_stats.online_cpus).toFixed(2) : 0;
                    
                    // 実メモリ使用量の算出
                    const memUsed = (s.memory_stats.usage / 1024 / 1024).toFixed(1);
                    const memPct = (s.memory_stats.usage / s.memory_stats.limit * 100).toFixed(1);
                    
                    // ゲージと数値の更新。100%を超える値にならないようキャップをかける
                    document.getElementById('cpu-text').innerText = `${cpu}%`;
                    document.getElementById('cpu-bar').style.width = `${Math.min(cpu, 100)}%`;
                    document.getElementById('mem-text').innerText = `${memUsed} MiB`;
                    document.getElementById('mem-bar').style.width = `${memPct}%`;
                } catch (err) { }
            };
        }
    </script>
</body>

</html>