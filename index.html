<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Go-Docker Control Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <style>
        :root {
            --bg: #0d0d0d;
            --panel: #1a1a1a;
            --border: #333;
            --accent: #0081cc;
            --text: #eee;
            --muted: #888;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
        }

        #login-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 1000;
        }

        .login-card {
            background: var(--panel);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            width: 320px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid var(--border);
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: #333;
            color: white;
            font-size: 12px;
        }

        button.primary {
            background: var(--accent);
            border: none;
            font-weight: bold;
            width: 100%;
            padding: 12px;
        }

        #app {
            display: none;
            height: 100vh;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 50px 1fr 200px;
        }

        header {
            grid-column: 1 / -1;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        #sidebar {
            grid-row: 2 / 4;
            background: var(--panel);
            border-right: 1px solid var(--border);
            padding: 10px;
            overflow-y: auto;
        }

        .container-item {
            padding: 10px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .container-item:hover {
            background: #2a2a2a;
        }

        .container-item.active {
            background: #222;
            border-left: 4px solid var(--accent);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 12px;
            background: var(--muted);
        }

        .dot.running {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        #main-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-box {
            flex: 1;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .term-header {
            background: #222;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        #xterm-container {
            flex: 1;
            position: relative;
            background-color: #000;
        }

        #term-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            background: #000;
            z-index: 5;
        }

        /* --- 下部パネルのレイアウト修正 --- */
        #detail-panel {
            grid-column: 2;
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: #222;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
        }

        .progress-bg {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 詳細グリッド用スタイル */
        .info-grid {
            display: grid;
            grid-template-columns: 75px 1fr;
            gap: 6px;
            font-size: 11px;
            color: #ccc;
        }

        .info-grid span:nth-child(odd) {
            color: var(--muted);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 9px;
            align-self: center;
        }

        .info-grid span:nth-child(even) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>Docker Manager</h2>
            <form id="login-form" onsubmit="event.preventDefault(); doLogin();">
                <input type="text" placeholder="Username" id="user" autocomplete="username">
                <input type="password" placeholder="Password" id="password" autocomplete="current-password">
                <button type="submit" class="primary">Login</button>
            </form>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="font-weight:600">Proxmox-Go Console</div>
            <div id="session-info" style="font-size:12px; color:var(--muted)">Session: Active</div>
        </header>

        <div id="sidebar">
            <div style="color:var(--muted); font-size:11px; margin-bottom:10px; padding-left:10px;">CONTAINERS</div>
            <div id="list-target"></div>
        </div>

        <div id="main-content">
            <div class="terminal-box">
                <div class="term-header">
                    <span id="term-name">Console: No Container Selected</span>
                    <div class="btn-group">
                        <button onclick="connectTerminal('attach')">Attach</button>
                        <button onclick="connectTerminal('exec')">Exec</button>
                    </div>
                </div>
                <div id="xterm-container">
                    <div id="term-placeholder">Select a container and click Attach/Exec</div>
                    <div id="terminal" style="height: 100%;"></div>
                </div>
            </div>
        </div>

        <div id="detail-panel">
            <div class="metric-card">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value" id="cpu-text">-</div>
                <div class="progress-bg">
                    <div id="cpu-bar" class="progress-fill"></div>
                </div>

                <div class="metric-label" style="margin-top:12px;">Memory</div>
                <div class="metric-value" id="mem-text">-</div>
                <div class="progress-bg">
                    <div id="mem-bar" class="progress-fill"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Uptime</div>
                <div class="metric-value" id="uptime-text">-</div>

                <div class="metric-label" style="margin-top:12px;">Storage Driver</div>
                <div class="metric-value" id="info-driver" style="font-size:14px;">-</div>
                <div style="font-size:10px; color:var(--muted);" id="info-disk-size">Size: -</div>
            </div>

            <div class="metric-card">
                <div class="info-grid">
                    <span>IP Addr</span><span id="info-ip">-</span>
                    <span>Gateway</span><span id="info-gw">-</span>
                    <span>Image</span><span id="info-img">-</span>
                    <span>Created</span><span id="info-created">-</span>
                </div>
            </div>

            <div class="metric-card">
                <div class="info-grid">
                    <span>Status</span><span id="info-status">-</span>
                    <span>Restart</span><span id="info-restart">-</span>
                    <span>Path</span><span id="info-path">-</span>
                    <span>Args</span><span id="info-args">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = "", selectedId = "", wsTerm, wsStats;
        let termDataListener;

        const term = new Terminal({
            convertEol: true,
            cursorBlink: true,
            theme: { background: '#000' },
            fontSize: 13,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));

        window.addEventListener('resize', () => {
            try { fitAddon.fit(); } catch (e) { }
        });

        async function doLogin() {
            const userEl = document.getElementById('user');
            const passEl = document.getElementById('password');
            const loginBtn = document.querySelector('#login-form button');

            try {
                loginBtn.disabled = true;
                loginBtn.innerText = "Logging in...";

                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userEl.value, password: passEl.value })
                });

                if (!res.ok) throw new Error("Login failed");

                const data = await res.json();
                token = data.token;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'grid';

                setTimeout(() => fitAddon.fit(), 100);
                fetchContainers();

            } catch (e) {
                alert("Login error: " + e.message);
                loginBtn.disabled = false;
                loginBtn.innerText = "Login";
            }
        }

        async function fetchContainers() {
            try {
                const res = await fetch('/api/containers', { headers: { 'Authorization': token } });
                const data = await res.json();
                let items = Array.isArray(data) ? data : (data.Items || []);

                document.getElementById('list-target').innerHTML = items.map(c => `
                    <div class="container-item" id="c-${c.Id}" onclick="selectContainer('${c.Id}', '${c.Names[0]}')">
                        <div class="dot ${c.State === 'running' ? 'running' : ''}"></div>
                        ${c.Names[0].replace('/', '')}
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function selectContainer(id, name) {
            selectedId = id;
            document.querySelectorAll('.container-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`c-${id}`);
            if (activeEl) activeEl.classList.add('active');
            document.getElementById('term-name').innerText = `Console: ${name}`;

            resetUI();
            loadInspectData(id);
        }

        function resetUI() {
            if (wsTerm) { wsTerm.close(); wsTerm = null; }
            if (wsStats) { wsStats.close(); wsStats = null; }
            term.reset();
            document.getElementById('term-placeholder').style.display = 'flex';
            // Reset metrics
            ['cpu-text', 'mem-text', 'uptime-text', 'info-driver', 'info-ip', 'info-img'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerText = "-";
            });
            document.getElementById('cpu-bar').style.width = "0%";
            document.getElementById('mem-bar').style.width = "0%";
        }

        async function loadInspectData(id) {
            try {
                const res = await fetch(`/api/container/inspect?id=${id}`, { headers: { 'Authorization': token } });
                const json = await res.json();
                const info = json.Raw || json;

                // Block 2: Uptime & Disk
                const started = new Date(info.State?.StartedAt);
                const uptime = isNaN(started) ? 0 : Math.floor((new Date() - started) / 1000 / 60);
                document.getElementById('uptime-text').innerText = info.State?.Running ? `${uptime} mins` : "Stopped";
                document.getElementById('info-driver').innerText = info.Driver || "N/A";
                document.getElementById('info-disk-size').innerText = "Size: " + (info.HostConfig?.StorageOpt?.size || "Default");

                // Block 3: Info A
                document.getElementById('info-ip').innerText = info.NetworkSettings?.IPAddress || "Host/None";
                document.getElementById('info-gw').innerText = info.NetworkSettings?.Gateway || "-";
                document.getElementById('info-img').innerText = (info.Config?.Image || "").split('@')[0];
                document.getElementById('info-created').innerText = new Date(info.Created).toLocaleDateString();

                // Block 4: Info B
                document.getElementById('info-status').innerText = info.State?.Status || "-";
                document.getElementById('info-restart').innerText = (info.RestartCount || 0) + " times";
                document.getElementById('info-path').innerText = info.Path || "-";
                document.getElementById('info-args').innerText = (info.Args || []).join(' ') || "none";

                startStats(id);
            } catch (e) { console.error(e); }
        }

        function connectTerminal(mode) {
            if (!selectedId) return;
            if (wsTerm) wsTerm.close();
            if (termDataListener) { termDataListener.dispose(); termDataListener = null; }

            document.getElementById('term-placeholder').style.display = 'none';
            term.reset();

            const wsUrl = `ws://${location.host}/ws/terminal?id=${selectedId}&mode=${mode}&token=${token}`;
            wsTerm = new WebSocket(wsUrl);
            wsTerm.binaryType = 'arraybuffer';

            wsTerm.onopen = () => { fitAddon.fit(); term.focus(); };
            wsTerm.onmessage = (e) => { term.write(new Uint8Array(e.data)); };
            wsTerm.onclose = () => { document.getElementById('term-placeholder').style.display = 'flex'; };

            termDataListener = term.onData(data => {
                if (wsTerm && wsTerm.readyState === WebSocket.OPEN) wsTerm.send(data);
            });
        }

        function startStats(id) {
            if (wsStats) wsStats.close();
            wsStats = new WebSocket(`ws://${location.host}/ws/stats?id=${id}&token=${token}`);
            wsStats.onmessage = async (e) => {
                try {
                    const text = (e.data instanceof Blob) ? await e.data.text() : e.data;
                    const s = JSON.parse(text);

                    // CPU Calculation
                    const cpuUsage = s.cpu_stats?.cpu_usage?.total_usage || 0;
                    const preCpuUsage = s.precpu_stats?.cpu_usage?.total_usage || 0;
                    const systemUsage = s.cpu_stats?.system_cpu_usage || 0;
                    const preSystemUsage = s.precpu_stats?.system_cpu_usage || 0;
                    const cpuDelta = cpuUsage - preCpuUsage;
                    const sysDelta = systemUsage - preSystemUsage;

                    let cpu = 0;
                    if (sysDelta > 0 && cpuDelta > 0) {
                        cpu = ((cpuDelta / sysDelta) * 100 * (s.cpu_stats.online_cpus || 1)).toFixed(2);
                    }

                    // Memory Calculation
                    const memUsed = (s.memory_stats?.usage || 0) / 1024 / 1024;
                    const memLimit = (s.memory_stats?.limit || 1) / 1024 / 1024;
                    const memPercent = ((s.memory_stats?.usage || 0) / (s.memory_stats?.limit || 1)) * 100;

                    document.getElementById('cpu-text').innerText = `${cpu}%`;
                    document.getElementById('cpu-bar').style.width = `${Math.min(cpu, 100)}%`;
                    document.getElementById('mem-text').innerText = `${memUsed.toFixed(1)} MiB`;
                    document.getElementById('mem-bar').style.width = `${Math.min(memPercent, 100)}%`;
                } catch (err) { }
            };
        }
    </script>
</body>

</html>