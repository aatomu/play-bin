<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Go-Docker Control Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <style>
        :root {
            --bg: #0d0d0d;
            --panel: #1a1a1a;
            --border: #333;
            --accent: #0081cc;
            --text: #eee;
            --muted: #888;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #login-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            z-index: 1000;
        }

        .login-card {
            background: var(--panel);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border);
            width: 320px;
            text-align: center;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid var(--border);
            color: white;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button.primary {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* レイアウト: 2列 + 下部パネル */
        #app {
            display: none;
            height: 100vh;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 50px 1fr 180px;
        }

        header {
            grid-column: 1 / -1;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        #sidebar {
            grid-row: 2 / 4;
            background: var(--panel);
            border-right: 1px solid var(--border);
            padding: 10px;
            overflow-y: auto;
        }

        .container-item {
            padding: 10px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .container-item:hover {
            background: #2a2a2a;
        }

        .container-item.active {
            background: #222;
            border-left: 4px solid var(--accent);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 12px;
            background: var(--muted);
        }

        .dot.running {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        #main-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-box {
            flex: 1;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .term-header {
            background: #222;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            height: 30px;
            flex-shrink: 0;
        }

        /* ターミナルコンテナ: 親要素いっぱいに広げる */
        #xterm-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            /* 余白除去のため重要 */
        }

        #term-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            font-size: 14px;
            background: #000;
            z-index: 5;
        }

        #detail-panel {
            grid-column: 2;
            background: var(--panel);
            border-top: 1px solid var(--border);
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .metric-card {
            background: #252525;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
        }

        .metric-label {
            font-size: 10px;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
        }

        .progress-bg {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 4px;
            font-size: 12px;
            color: #ccc;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>Docker Manager</h2>
            <input type="text" placeholder="Admin" id="user" value="admin">
            <button class="primary" onclick="doLogin()">Login</button>
        </div>
    </div>

    <div id="app">
        <header>
            <div style="font-weight:600">Proxmox-Go Console</div>
            <div id="session-info" style="font-size:12px; color:var(--muted)">Session: Active</div>
        </header>

        <div id="sidebar">
            <div style="color:var(--muted); font-size:11px; margin-bottom:10px; padding-left:10px;">CONTAINERS</div>
            <div id="list-target"></div>
        </div>

        <div id="main-content">
            <div class="terminal-box">
                <div class="term-header">
                    <span id="term-name">Console: No Container Selected</span>
                    <div class="btn-group">
                        <button onclick="connectTerminal('attach')">Attach</button>
                        <button onclick="connectTerminal('exec')">Exec</button>
                    </div>
                </div>
                <div id="xterm-container">
                    <div id="term-placeholder">Select a container and click Attach/Exec</div>
                    <div id="terminal" style="height: 100%;"></div>
                </div>
            </div>
        </div>

        <div id="detail-panel">
            <div class="metric-card">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value" id="cpu-text">-</div>
                <div class="progress-bg">
                    <div id="cpu-bar" class="progress-fill"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Memory</div>
                <div class="metric-value" id="mem-text">-</div>
                <div class="progress-bg">
                    <div id="mem-bar" class="progress-fill"></div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Uptime</div>
                <div class="metric-value" id="uptime-text">-</div>
            </div>
            <div class="metric-card">
                <div class="info-grid">
                    <span>IP</span><span id="info-ip">-</span>
                    <span>Img</span><span id="info-img">-</span>
                    <span>Path</span><span id="info-path" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = "", selectedId = "", wsTerm, wsStats;

        // ターミナル設定: Minecraft等で見やすいようカーソル点滅を有効化
        const term = new Terminal({
            convertEol: true,
            cursorBlink: true,
            theme: { background: '#000' },
            fontSize: 13,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });

        // FitAddonの初期化 (コンテナサイズに合わせてターミナルをリサイズする)
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));

        // ウィンドウリサイズ時にターミナルも追従させる
        window.addEventListener('resize', () => {
            try {
                fitAddon.fit();
            } catch (e) { console.log(e); }
        });

        async function doLogin() {
            try {
                const res = await fetch('/api/login', { method: 'POST' });
                if (!res.ok) throw new Error("Login failed");
                const data = await res.json();
                token = data.token;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'grid';
                // 画面表示後にレイアウト計算を走らせる
                setTimeout(() => fitAddon.fit(), 100);
                fetchContainers();
            } catch (e) {
                alert("Login error: " + e.message);
            }
        }

        async function fetchContainers() {
            try {
                const res = await fetch('/api/containers', { headers: { 'Authorization': token } });
                const data = await res.json();

                // エラーチェック: 配列でない場合は処理を中断 (mapエラー回避)
                let items = [];
                if (Array.isArray(data)) {
                    items = data;
                } else if (data && Array.isArray(data.Items)) {
                    items = data.Items;
                } else {
                    console.error("Unexpected API response:", data);
                    return;
                }

                document.getElementById('list-target').innerHTML = items.map(c => `
            <div class="container-item" id="c-${c.Id}" onclick="selectContainer('${c.Id}', '${c.Names[0]}')">
                <div class="dot ${c.State === 'running' ? 'running' : ''}"></div>
                ${c.Names[0].replace('/', '')}
            </div>
          `).join('');
            } catch (e) {
                console.error("Fetch error:", e);
            }
        }

        function selectContainer(id, name) {
            selectedId = id;
            document.querySelectorAll('.container-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`c-${id}`);
            if (activeEl) activeEl.classList.add('active');
            document.getElementById('term-name').innerText = `Console: ${name}`;

            resetUI();
            loadInspectData(id);
        }

        function resetUI() {
            if (wsTerm) { wsTerm.close(); wsTerm = null; }
            if (wsStats) { wsStats.close(); wsStats = null; }
            term.reset();
            document.getElementById('term-placeholder').style.display = 'flex';
            document.getElementById('cpu-text').innerText = "-";
            document.getElementById('cpu-bar').style.width = "0%";
            document.getElementById('mem-text').innerText = "-";
            document.getElementById('mem-bar').style.width = "0%";
        }

        async function loadInspectData(id) {
            try {
                const res = await fetch(`/api/container/inspect?id=${id}`, { headers: { 'Authorization': token } });
                const json = await res.json();
                // Docker APIのバージョンによってはRawの中にある場合がある
                const info = json.Raw || json;

                document.getElementById('info-ip').innerText = info.NetworkSettings?.IPAddress || "Host/None";
                document.getElementById('info-img').innerText = (info.Config?.Image || "").split('@')[0];
                document.getElementById('info-path').innerText = info.Path || "";

                const started = new Date(info.State?.StartedAt);
                const uptime = isNaN(started) ? 0 : Math.floor((new Date() - started) / 1000 / 60);
                document.getElementById('uptime-text').innerText = info.State?.Running ? `${uptime} mins` : "Stopped";

                startStats(id);
            } catch (e) {
                console.error("Inspect error:", e);
            }
        }

        function connectTerminal(mode) {
            if (!selectedId) return;
            if (wsTerm) wsTerm.close();

            document.getElementById('term-placeholder').style.display = 'none';
            term.reset();

            // WebSocket接続
            wsTerm = new WebSocket(`ws://${location.host}/ws/terminal?id=${selectedId}&mode=${mode}&token=${token}`);
            wsTerm.binaryType = 'arraybuffer';

            wsTerm.onopen = () => {
                // 接続時にサイズ調整を実行
                fitAddon.fit();
                term.focus();
            };

            wsTerm.onmessage = (e) => {
                // バイナリデータとして受信してxtermに流す
                term.write(new Uint8Array(e.data));
            };

            term.onData(data => {
                if (wsTerm && wsTerm.readyState === WebSocket.OPEN) {
                    wsTerm.send(data);
                }
            });
        }

        function startStats(id) {
            if (wsStats) wsStats.close();
            wsStats = new WebSocket(`ws://${location.host}/ws/stats?id=${id}&token=${token}`);
            wsStats.onmessage = async (e) => {
                try {
                    // stats APIはJSON文字列で返ってくる前提
                    const text = (e.data instanceof Blob) ? await e.data.text() : e.data;
                    const s = JSON.parse(text);

                    // 安全にプロパティへアクセス
                    const cpuUsage = s.cpu_stats?.cpu_usage?.total_usage || 0;
                    const preCpuUsage = s.precpu_stats?.cpu_usage?.total_usage || 0;
                    const systemUsage = s.cpu_stats?.system_cpu_usage || 0;
                    const preSystemUsage = s.precpu_stats?.system_cpu_usage || 0;

                    const cpuDelta = cpuUsage - preCpuUsage;
                    const sysDelta = systemUsage - preSystemUsage;

                    let cpu = 0;
                    if (sysDelta > 0 && cpuDelta > 0) {
                        // コア数を考慮する場合 s.cpu_stats.online_cpus を掛ける必要があるが簡易版
                        cpu = ((cpuDelta / sysDelta) * 100 * (s.cpu_stats.online_cpus || 1)).toFixed(2);
                    }

                    const memUsed = (s.memory_stats?.usage || 0) / 1024 / 1024;
                    const memLimit = (s.memory_stats?.limit || 1) / 1024 / 1024; // MB
                    const memPercent = ((s.memory_stats?.usage || 0) / (s.memory_stats?.limit || 1)) * 100;

                    document.getElementById('cpu-text').innerText = `${cpu}%`;
                    document.getElementById('cpu-bar').style.width = `${Math.min(cpu, 100)}%`;
                    document.getElementById('mem-text').innerText = `${memUsed.toFixed(1)} MiB`;
                    document.getElementById('mem-bar').style.width = `${Math.min(memPercent, 100)}%`;
                } catch (err) {
                    // 接続切り替え時などにJSONパースエラーが出ることがあるので無視
                }
            }
        }
    </script>
</body>

</html>