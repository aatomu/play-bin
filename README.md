# play-bin

Dockerコンテナとして稼働するゲームサーバー等を、Web UIやDiscordから一括管理するためのツールです。

### 主な機能

- Webブラウザからのコンテナ操作（起動・停止・コンソール表示）
- Discordスラッシュコマンドによるコンテナ制御
- コンテナログの特定キーワードを検知してDiscordへ通知
- SFTPサーバー機能による、安全で高速なファイル管理
- rsyncを利用した効率的なインクリメンタルバックアップ

### 導入手順

1. 実行バイナリの準備
   Go言語がインストールされた環境で `go build .` を実行し、実行ファイルを生成します。

2. 設定ファイルの作成
   `config.example.json` を `config.json` という名前でコピーし、環境に合わせて各項目を編集します。詳細は後述の「設定ファイルの解説」を参照してください。

3. ログ通知設定の作成（任意）
   コンテナログをDiscordに転送したい場合は、`logs.json` を開き、正規表現と転送先のWebhook URLを設定します。

4. サービスの起動
   生成されたバイナリを実行します。

### 設定ファイルの解説

設定ファイル（config.json）の主要なブロックについて説明します。

### 全般設定 (top level)

- `httpListen`: Web UIおよびAPIサーバーが待機するアドレスとポートです。省略または空欄にするとWebサーバーは起動しません。
- `sftpListen`: ファイル操作用SFTPサーバーが待機するアドレスとポートです。省略または空欄にするとSFTPサーバーは起動しません。

### ユーザー設定 (users)

管理権限を持つユーザーを定義します。

- `discord`: ユーザーのDiscord IDです。
- `password`: Web UIおよびSFTPログインに使用するパスワードです。
- `controllable`: 操作を許可するコンテナ名のリストです。`["*"]` とすると全てのコンテナを操作できます。

### サーバー設定 (servers)

管理対象となるコンテナ（サーバー）ごとに設定を行います。

- `workingDir`: ホスト側での作業ディレクトリです。
- `image`: 使用するDockerイメージ名です。
- `network`: ポート開放やネットワークモードの設定です。
- `mount`: ホストのディレクトリとコンテナ内のパスを紐付けます（SFTPはこの設定を元にアクセス範囲を決定します）。
- `commands.backup`: バックアップの元パス（src）と保存先（dest）を指定します。
- `discord.token`: Discord Bot用のトークンですが、省略可能です（省略した場合はそのサーバーのBot機能が無効になります）。
- `discord.channel`: 操作コマンドを受け取るチャンネルIDですが、省略可能です。

### SFTPサーバーの利用方法

SFTP機能を使うことで、WinSCPやFileZillaなどのツールから直接コンテナ内のファイルを編集できます。

1. SFTPクライアントソフトを開きます。
2. ホスト名にサーバーのIPアドレス、ポートに設定した番号（例: 2022）を入力します。
3. `config.json` に設定したユーザー名とパスワードでログインします。
4. ログインに成功すると、許可されたコンテナの名前がディレクトリとして表示されます。

### バックアップの実行

1. Web UIまたはDiscordから「backup」アクションを実行します。
2. 内部でコンテナを安全に停止させた後、rsyncによる差分バックアップが行われます。
3. バックアップはタイムスタンプが付与されたフォルダに保存され、最新版は `latest` という名前でリンクされます。
